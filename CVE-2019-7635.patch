
# HG changeset patch
# User Ozkan Sezer <sezeroz@gmail.com>
# Date 1562795702 -10800
# Node ID a3a7cac00d5fec6b43da5bfd1746d82ec616cdc3
# Parent  8d6699dd9d74f07acb94a4c1acea4281ea7851bf
bmp: backport CVE-2019-7635 (SDL bug 4498) fix from main 2.0 branch:
mainstream commit:
https://hg.libsdl.org/SDL_image/rev/03bd33e8cb49

diff -r 8d6699dd9d74 -r a3a7cac00d5f IMG_bmp.c
--- a/IMG_bmp.c	Wed Jul 10 23:51:28 2019 +0300
+++ b/IMG_bmp.c	Thu Jul 11 00:55:02 2019 +0300
@@ -292,6 +292,14 @@
 			ExpandBMP = biBitCount;
 			biBitCount = 8;
 			break;
+		case 2:
+		case 3:
+		case 5:
+		case 6:
+		case 7:
+			IMG_SetError("%d-bpp BMP images are not supported", biBitCount);
+			was_error = SDL_TRUE;
+			goto done;
 		default:
 			ExpandBMP = 0;
 			break;
@@ -444,7 +452,12 @@
 						goto done;
 					}
 				}
-				*(bits+i) = (pixel>>shift);
+				bits[i] = (pixel >> shift);
+				if (bits[i] >= biClrUsed) {
+					IMG_SetError("A BMP image contains a pixel with a color out of the palette");
+					was_error = SDL_TRUE;
+					goto done;
+				}
 				pixel <<= ExpandBMP;
 			} }
 			break;
@@ -456,6 +469,15 @@
 				was_error = SDL_TRUE;
 				goto done;
 			}
+			if (biBitCount == 8 && palette && biClrUsed < (1 << biBitCount)) {
+				for (i = 0; i < surface->w; ++i) {
+					if (bits[i] >= biClrUsed) {
+						IMG_SetError("A BMP image contains a pixel with a color out of the palette");
+						was_error = SDL_TRUE;
+						goto done;
+					}
+				}
+			}
 #if SDL_BYTEORDER == SDL_BIG_ENDIAN
 			/* Byte-swap the pixels if needed. Note that the 24bpp
 			   case has already been taken care of above. */

